---
layout: post
title: Delegated Credentials---零信任网络下的新身份认证方式
categories: Network
keywords: TLS, GM, Network
---

## 背景       
传统的基于边界的网络安全架构通过防火墙、WAF、IPS等边界安全产品/方案对企业网络边界进行重重防护，然而随着近些年云技术的不断发展，各个企业也在不断拥抱公有云，专有云以及混合云的架构模式，网络安全的边界也在不断模糊。在云模式下，即使进入逻辑上的企业内网环境，也很难保证网络的安全，由此，John Kindervag在2010年提出的零信任网络模型逐渐走入大家的视野，零信任网络模型的目标是基于身份和访问控制从0构建企业新的逻辑边界，在零信任网络的范式下，在现有的体系上如何对每台设备进行安全的身份认证是一个不小的挑战。今天要分享的Delegated Credentials技术属于身份认证技术的一种，由FaceBook和CloudFlare在17年提出，其目的在于给出一种新的身份认证方式，并基于此提升私钥管理的安全性。本文将对这项技术的细节以及优劣进行分析，阅读本文大概需要20分钟。章节安排如下：

- 第二章将简单描述PKI体系下身份认证的流程，以及其在云环境下面对的挑战。
- 第三章将简单阐述Delegated Credentials解决问题的思路和其对应的一些技术的分析。
- 第四章对Delegated Credentials这项技术的细节做一些说明。
- 第五章对Delegated Credentials技术的优劣进行了一些总结和评价。


## PKI下的身份认证流程及其面对的挑战
整个PKI身份认证体系的核心是数字证书及其对应的私钥，目前的数字证书均按照x509结构，我们以普通的web浏览器访问网站的流程为例，稍微详细的说明下一个x509证书的结构及其对应的身份认证流程，本文默认的标准是x509 V3(这也是当前默认的证书标准)。当我们在验证证书是否有效时，我们实质验证的是一个证书链，整个证书链的结构如下：

![](/images/self-drawn/intro-of-delegated-credential/cert.png)

完整的身份流程如下：

- 在client发起会话请求前，会在浏览器中导入信任的CA证书(即图中根证书)，这个CA证书一般由权威机构发放。
- client与server成功的建立起会话后，会收到server的证书链(对应图中的网站证书及一级证书)，以及server对本次会话的关键信息的签名，然后开始验证流程。
- client首先使用网站证书的公钥来验证server提供的本次会话的关键信息的签名(具体验签流程可以参看ECDSA和RSA签名及验签算法)，验证成功则说明client当前会话的对端是网站证书所有方(即没有中间人篡改信息)，但网站证书并不受信任，下面开始向上验证证书链。
- client通过server提供的证书链，拿到网站证书的上级证书(即图中的一级证书)，并通过一级证书中的公钥字段及网站证书的签名字段进行验证，验证成功则说明网站证书是由一级证书颁发且没有被篡改，但此时的一级证书仍不受信任，因此继续递归向上，通过一级证书的颁发机构字段向上搜寻证书。
- 重复上述步骤，验证一级证书是由其上级证书颁发且没被篡改，而此时我们能在浏览器中发现我们信任了根证书，则这条证书链是被信任的，则整个会话是被信任的。

实际应用中，证书链可能比较长，即不仅有一级证书，还可能有二级，三级..证书，但验证流程都是步骤4的递归重复。

PKI体系是目前身份认证方法中最安全的体系之一，但这套体系仍面临着不小的挑战：从流程我们可以看到，身份认证的安全性完全由公私钥对提供的算法来进行保证，而一旦一条证书链上某一个证书对应的私钥泄漏，那么该证书包括其以下的证书全都不再可以信任。私钥泄漏以后造成的影响是巨大的，首先，私钥泄漏意味着中间人可以随意冒充网站的身份与client进行通信，其次，从验证证书链的流程我们可以看到，验证流程只有递归向上的部分，这也就意味着我们除了在浏览器配置单独不信任某个证书以外，没有其他任何办法来处理某个私钥已经泄漏的证书。而client的行为是难以控制的，很难保证每个client都及时同步哪些证书已不再能被信任，相应的处理方法如典型的[Online Certificate Status Protocol (OCSP)](https://datatracker.ietf.org/doc/html/rfc6960)，以及chrome的[CRLsets](https://www.imperialviolet.org/2012/02/05/crlsets.html)，都没能很好的解决这个问题。

在零信任网络的范式下，即使在内网环境，每个节点也仍需进行身份验证，按照PKI流程，每一个节点都需要部署公私钥对，相比于传统环境，私钥泄漏的风险大大增加，这也是Delegated Credentials这项技术提出的背景。


## Delegated Credentials的解决方案对比分析
从解决思路这个方面来说，Delegated Credentials属于一个不是新技术的新技术，为什么这么说呢？我们来简单描述下Delegated Credentials的思路：用企业的证书和私钥单独签发出一个类似证书的凭证，这个凭证就叫做Delegated Credentials，而后续的https会话都可以利用Delegated Credentials来进行签名相关的操作。也就是说Delegated Credentials实质上就是一个简化了功能的证书私钥对。

这里也解释一下为什么不直接用企业证书签发新的证书，这就得提一下x509.V3标准下的证书标准，在该标准下证书扩展字段中存在一个X509v3 Extended Key Usage字段，用于说明证书的用途，而企业拿到的证书通常只能用于https会话使用，而不可以再进行证书的签发，这么做的目的也很明确，为了防止企业滥用证书，导致证书链混乱，无法管理。

再来对比下目前典型对私钥安全性的方案，如cloudflare提出的keyless协议，keyless协议也不是一个十分复杂的东西，其本质思路在于将server的私钥集中部署到更安全的keycenter集群，而前端负责ssl卸载的设备收到https请求后，将需要签名的数据基于keyless协议打包，转发到keycenter集群进行签名操作。这样就保证了私钥尽可能少的对外暴露，增加安全性，整个流程如下:

![](/images/self-drawn/intro-of-delegated-credential/keyserver.png)

可以看到在keyless架构下，网络链路会多一跳，这不仅是多的性能损耗，新增系统同样也会增加稳定性的风险。

## Delegated Credentials的细节分析
这一节我们来详细分析一下Delegated Credentials的相关技术，为表述方便，后文用DC来表示Delegated Credentials，通过前面的分析，我们了解到DC是一个类似证书私钥对的东西，不太严谨的说，我们甚至可以简单的把DC理解成企业证书的下一级证书，我们先来看使用DC进行握手的流程，首先明确一下，DC在第二版draft及以后就仅支持tls1.3了，所以我们以tls1.3会话过程为例来进行说明，如下图：

![](/images/self-drawn/intro-of-delegated-credential/tls13.jpg)

从流程上我们可以看到，DC同证书承载的功能是一样的，因此，对于其签名及验签功能而言，其结构中仅需要具备公私钥对以及相应的算法说明即可，而对于其身份验证的流程而言，由于每次会话中DC与server证书链是强绑定的，因此无需任何颁发者字段说明。由此，DC相比与x509，仅需要简短的结构体就能实现其功能，一个DC的结构体如下：

![](/images/self-drawn/intro-of-delegated-credential/dc.jpg)

需要注意的是，DC不仅要求tls会话支持相应的扩展，同时也要求x509证书也支持相应的扩展，DC相应的draft要求x509格式证书必须在其extension字段中定义新的DelegationUsage字段，用于说明是否支持DC，同时，RFC中也定义了很多细节上的要求，比如在tls会话中，每个DC相关的扩展应该在哪些扩展之后发送，以及DC对应的签名算法的相关要求，DC对应的签名算法虽然可以和证书对应的签名算法不一致，但必须属于tls会话中握手算法扩展中定义的算法之一。

## 真的完美的解决了问题吗？
由前文我们可以看到，DC的优势是明显的，在尽可能小的影响tls会话的前提下，给出了一种提升私钥安全性的方案，简洁，易用，特别是在零信任网络范式下，每个设备拥有一个DC不仅可以保证安全性，实现起来也是很容易的。但是，DC真的完美无暇吗？我们来看看它的问题所在：

- 一次tls握手过程是否使用DC是依赖其相应的扩展字段的，在现实场景中，client端(支付宝app)是无法一次性全量升级到支持DC的，甚至可以说升级到全量使用DC的过程是相当漫长的，server为了保证对不使用DC的client兼容，仍旧需要维持和之前一样的方案，在这段漫长的升级过程中，DC的存在显得有些鸡肋，更为遗憾的是，为了保证这种兼容性，我们甚至无法隔离出一个集群来灰度测试server只部署DC的情况。
- DC使用还需依赖证书扩展，而对于大部分企业来说，在申请证书后，直到该证书过期为止，都不太愿意主动申请新的证书，而一份证书的有效期一般以年为单位，这意味着推行DC机制会存在不小的压力。
- DC除了超时意外没有其他的撤销办法：x509证书的私钥泄漏后，虽然向client同步消息相对困难，但毕竟有方法进行通知，而DC缺乏唯一的身份凭证(即x509证书中的序列号)，是没有办法吊销的，这也就意味着，私钥一旦泄漏，则在DC超时这段时间内，都没有办法限制其安全隐患的扩散，对于这个问题，draft给出的建议是DC的有效时间不应超过7天，只能说治标不治本吧。
- 在某些场景下，节点的性能瓶颈来自于该节点自身CPU能力不足，难以同时支持大量的签名及加密算法，此时仍需要采用keyless+专用硬件计算的模式来解决问题，如果完全采用DC机制，大量的DC私钥如何在keycenter集群同步，并识别其对应的公钥，也是一个问题。

## 结语
虽然DC看起来仍有不小的问题，但在零信任网络中，它带来的好处也是非常有诱惑力的，我们预计在BabaSSL的下个版本中就会支持这个功能，同时也会针对阿里自身的场景对其做一定优化，希望未来DC会在云的安全场景下大放异彩。
