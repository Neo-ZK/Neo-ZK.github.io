---
layout: post
title: TLS1.3+国密---国密的下一站
categories: Network
keywords: TLS, GM, Network
---

## 背景       
说起TLS，大家一定不会陌生，tls可以说是整个互联网安全的基石，保障着我们的通信数据的安全。自从2014年Heartbleed漏洞被发现以来，网络安全受人关注的程度越来越高，出于更安全更快捷的需求，tls1.3协议也随之被提出，其相应的RFC于2018年正式发布。随着网络安全越来越受到重视，安全战略也逐步上升到国家战略的高度，国家密码局在2010年底公布了我国自主研制的“椭圆曲线公钥密码算法”（SM2算法），并随后陆续发布了国密算法SM1-SM9(SM代表商密的拼音大写)。而商密技术现在也通常称为GM(国密)，今天我们就来聊聊国密的相关技术。


## TLS1.3协议及GM算法
首先先让大家对这TLS和GM之间的关系有一个基本的概念，我们先以一个典型的TLS1.2中的密钥套件为例(之所以不用TLS1.3的套件，是因为TLS1.2相对更直观，并且现阶段GM对应的GM/T 0024标准是基于TLS1.0设计的，其算法套件格式和TLS1.2更接近，更方便大家理解)：

![](/images/self-drawn/tls13-gm/tls12-cipher.png)  

对应到我们的国密的算法上，则各个算法对应的套件如下：
- 密钥交换算法：SM2
- 数字签名算法：SM2（SM2将签名和密钥交换算法统一称做SM2算法，同时对应的ECC曲线也叫SM2）
- 对称加密算法：SM4
- hash算法：SM3

也就是说，国密局针对安全握手各个阶段所需要的算法都出台了一份自主可控的算法。

## 国密的优势与挑战
先来简单总结下国密的典型优势：
- 更安全：SM2作为一种ECC算法(256位)的安全性是要高于2048位的RSA的。同时SM3的摘要长度为256bit，安全强度也是要高于当时主流的MD5算法及SHA1算法的
- 更快速：在通讯过程中，256位的SM2算法相比于2048位的RSA算法，可以传输更少的数据，也就意味着更少的传输时间，同时在签名过程上，SM2算法速度要优于RSA不少(大约在10倍左右)。
- 自主可控：在目前这个国际形势下，这是最最最关键的一点！

从这些角度来看，国密是中国密码的一次革新，但这些年却一直没有大面积推行开来，说明其本身肯定还是面临着一些不小的挑战的，这里抛开一些细节的小问题，谈一谈国密面临的几个比较严重的挑战：

### 速度不够快(挑战难度★★★)
国密性能瓶颈主要在SM2和SM4这两个算法上，首先先谈谈SM2算法，前面我们提到，SM2包括了签名算法和密钥交换算法，当SM2作为签名算法时，性能要快于RSA2048不少，但在验证签名的性能上，相比RSA2048就要慢很多(大约只有RSA2048的1/20)，这还在可接受范围内，然而到了密钥交换的流程中，SM2算法基本就被RSA和ECDHE算法碾压了，目前这一块的业内解决方案为针对国密算法专门设计相应的FPGA，进行加速处理，国内如江南天安等公司已经在提供相关设备了。

对于SM4而言，其对标的算法是AES，如果从本身的加密原理上来看，SM4和AES的性能并没有多大差距，然而AES由于普遍性实在太强，典型的aes实现都基于intel的SIMD指令集对其进行了并行化加速，而SM4目前只有纯软的实现，性能上自然有不小的差距。

### 需要双证书(挑战难度★★★★)
要把双证书讲清楚首先需要大家理解下PKI密钥协商机制，具体的流程及原理在文末有几篇文章，这里我给一个最简单的说明，典型的密钥协商算法分为两种：RSA，ECDHE。对于RSA来说，密钥协商算法核心的性质在于用公钥加密的数据可以用私钥解密，整个密钥协商流程简化如下图：

![](/images/self-drawn/tls13-gm/tls-handshake.png)  

而ECDHE是基于DH和ECC的算法，理解起来更加容易，流程简化如下图：

![](/images/self-drawn/tls13-gm/ecdhe.png)

我们再来谈双证书这个事情，双证书分为签名证书和加密证书，这套体系的目的是满足国家对于重要数据的监管需求，即对于被监管的业务，需要有技术手段可以监管你的https数据(获取数据的明文)。而加密证书便由此催生。回到前文所述的tls握手过程中来，以RSA握手为例，中间人持有有你的私钥，也就能导出你的对称密钥，也就拿到了你的所有明文数据。而双证书体系则是对于被监管业务而言，由重要职能机构持有你的加密证书的私钥，并且加密生成对称密钥的随机数a时必须使用加密证书。对于ECDHE来说，server的随机数c就不再是随机的了，而是由加密证书决定的一个值，也就意味着职能机构理论上是可以导出监管业务使用的对称密钥的，从而达到监管业务的目的。

这套体系也着实面临着一些挑战，最大的问题在于目前所有主流密码库如openssl,boringssl都不支持，那么这也就意味着如果要推进这套体系的普适度，要么基于主流密码库开发，并推进开源社区接受，进而慢慢渗透到国内用户把这套体系用起来，要么在尽可能兼容目前密码体系的情况下开发一套新的密码库并强制国内用户替换，每一种办法都存在不小的难度。

### 优化空间小(挑战难度★★★★)
我们回顾下RSA和ECDHE的密钥交换流程，在RSA中，client必须要拿到server的证书才能加密生成对称密钥的材料，也就意味着握手至少需要2个RTT，而在ECDHE中，1个RTT就可以完成对称密钥的协商。在TLS1.3的1RTT标准握手流程中，明确定义了废除RSA握手，只支持ECDHE。然而国密在GM/T 0024标准里面要求，使用ECDHE密钥交换算法必须要求client也持有证书，其背景在于这个算法套件是针对MTLS场景设计的。对于普通互联网场景，一般客户端都不会携带证书凭证，这就造成了一个死锁，想用tls1.3->需要ECDHE->需要client有证书->没有证书且不想用证书->问题无解。

## tls1.3+国密算法
当然，有问题总有解法，现阶段的矛盾主要在于GM算法大面积铺开的困难，难么我们其实可以先尽量对于双证书监管稍作放松，而互联网场景大家更关注用户体验，那我们从这个目标出发，我们提出了tls1.3+gm的标准化草案，并正式形成了一份[RFC](https://datatracker.ietf.org/doc/html/rfc8998)。

![](/images/self-drawn/tls13-gm/rfc.png)

在这份RFC中，从流程上来说，我们在ECDHE算法上取消了client证书的要求，并暂时放宽了双证书的需求，由此推出了两个完整的国密算法套件，并确定了签名算法及曲线的标准号。同时我们基于TLS1.3的AEAD需求，定义了SM4的GCM模式和CCM模式，总的来说，整个draft定义了以下几个标准：
- 国密SM2曲线的标准号：curveSM2(41)，这个标准号的作用允许client和server在进行TLS1.3握手时，使用curveSM2作为约定曲线，相当于让ECDHE_SM2成为了TLS1.3中的国际标准(当然这里不需要client持有证书)。
- 基于SM2及SM3的签名算法标准号：sm2sig_sm3(0x0708)，这个标准号的功能在于以后在TLS1.3的流程中，如果server持有的是国密证书，则可以默认采用sm2sig_sm3作为签名算法，而它的意义在于：国密证书从此也成了标准。
- 基于TLS1.3及SM2,SM3,SM4算法的密钥套件：TLS_SM4_GCM_SM3(0x00,0xC6)以及TLS_SM4_CCM_SM3(0x00,0xC7)，这两个套件就更牛逼了，它意味着从此你可以按照标准使用tls1.3的1RTT握手+国密算法，既满足国家标准要求，又能够快速方便。

当然，标准也需要工程化的落地实现，而往往工程实现才是真正决定一份算法是否好用的绝对因素。针对SM2/3/4性能较差的问题，我们设计并落地了很多方案来进行优化，诸如： 异步化的SM2硬件加速流程；基于SIMD的SM4软优化实现等。基于这些技术，真正做到了让国密在生产可用，开销可控。相关技术的实现都可以在我们的[BabaSSL开源库](https://github.com/BabaSSL/BabaSSL)中进行实现，欢迎各位读者尝鲜体验。